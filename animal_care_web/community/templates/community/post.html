{% block content %}

<div>
    <div>
        <div class="">
            <a href="/community/board/">게시판</a>
        </div>
        <div>
            <h1>{{ post.title }}</h1>
        </div>
        <div>
            <span>{{ post.user }}</span>
            <i class="dot"> ・ </i>
            <span class="se_publishDate pcol2">{{ post.created_at }}</span>
        </div>
        <hr>
    </div>
    <div class="main-content">
        <div>
            <span>{{ post.content }}</span>
        </div>
        <div>
            {% if post.image %}
            <!-- 이미지가 있을 경우 이미지 출력 -->
            <img src="{{ post.image.url }}" alt="" height="600">
            <br>
            {% endif %}
        </div>

    </div>
</div>

<div class="post-footer">
    <div class="like-btn-container" style="float: right; margin-right: 10px;">
        <img id="like-button" src="{% if request.user in post.like_users.all %}/static/img/heart.svg{% else %}/static/img/heart-fill.svg{% endif %}" data-post-id="{{ post.pk }}" />
    </div>
    <div class="postedit-btn" style="float: right; margin-right: 10px;"">
        {% if post.user.id == request.user.id %}
            <i class="aline"></i>
            <form action="delete/" method="POST" style="display: inline;">
                {% csrf_token %}
                <input type="submit" value="삭제">
            </form>
            <form action="postupdate/" method="GET" style="display: inline;">
                <input type="submit" value="수정">
            </form>
        {% endif %}
    </div>
</div>

<div class="postComment">
    <div class="comments">

    </div>

    <div class="comment-box">

    </div>

</div>




    <ul>
        <!-- 각 댓글 아래에 답글 작성 폼 포함 -->
        {% for comment in comments %}
         {% if not comment.parent %}
            <li>
                <!-- 댓글 작성자, 내용, 작성일 출력 -->
                {{ comment.user }}<br>
                {{ comment.content }}<br>
                {{ comment.created_at }}

                <!-- 현재 사용자가 댓글 작성자일 경우 삭제 및 수정 버튼 표시 -->
                {% if comment.user.id == request.user.id %}
                <button class="edit-btn" data-comment-id="{{ comment.id }}">수정</button>
                    <!-- 수정 폼 -->
                    <form class="edit-form" action="{% url 'community:update_comment' pk=post.pk comment_id=comment.pk %}" method="POST" style="display: none;">
                        {% csrf_token %}
                        {{ comment_form }}
                        <input type="submit" value="저장">
                    </form>
                    <form action="{% url 'community:delete_comment' post_id=post.pk comment_id=comment.pk %}" method="POST">
                        {% csrf_token %}
                        <input type="submit" value="삭제">
                    </form>
                {% endif %}

                <!-- 답글 버튼 -->
                <button class="reply-btn" data-comment-id="{{ comment.id }}">답글 작성</button>

                <!-- 대댓글 목록 출력 -->
                <ul>
                    {% for child in comment.children.all %}
                        <li>
                            <!-- 대댓글 작성자, 내용, 작성일 출력 -->
                            {{ child.user }}<br>
                            {{ child.content }}<br>
                            {{ child.created_at }}
                        </li>
                    {% endfor %}
                </ul>

                <!-- 답글 작성 폼 -->
                <form class="reply-form" action="{% url 'community:create_comment' pk=post.pk %}" method="POST" style="display: none;">
                    {% csrf_token %}
                    <!-- 부모 댓글의 ID 전달 -->
                    <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
                    {{ comment_form }}
                    <input type="submit" value="답글 작성">
                </form>

                <hr>
            </li>
        {% endif %}
        {% endfor %}
    </ul>

    <!-- 댓글 작성 폼 -->
    <form action="{% url 'community:create_comment' pk=post.pk %}" method="POST">
        {% csrf_token %}
        {{ comment_form }}
        <input type="submit" value="댓글 작성">
    </form>

    <!-- 목록으로 돌아가는 링크 출력 -->
    <a href="/community/board/">목록</a>

    <!-- jQuery CDN 추가 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        $(document).ready(function() {
            // 답글 버튼 클릭 시 해당 댓글의 답글 작성 폼 토글
            $(".reply-btn").click(function() {
                // 클릭된 버튼의 부모 요소인 li를 찾고 그 하위의 답글 폼을 찾아서 토글
                $(this).closest('li').find('.reply-form').toggle();
            });
        });
        $(document).ready(function() {
            $(".edit-btn").click(function() {
                console.log("수정 버튼 클릭됨");
                $(this).closest('li').find('.edit-form').toggle();
            });
        });

        $(document).ready(function() {
        $('#like-button').on('click', function() {
            var postId = $(this).data('post-id');
            $.ajax({
                type: 'POST',
                url: '/community/board/' + postId + '/like/',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    // 좋아요 요청이 성공하면 UI를 업데이트합니다.
                    if (data.liked) {
                        $('#like-button').attr('src', '/static/img/heart-fill.svg');
                    } else {
                        $('#like-button').attr('src', '/static/img/heart.svg');
                    }
                }
            });
        });
    });

        // var i = 0;
        // $('#like-button').on('click', function() {
        //     if (i == 0) {
        //         $(this).attr('src', '/static/img/heart-fill.svg');
        //         i++;
        //     } else if (i == 1) {
        //         $(this).attr('src', '/static/img/heart.svg');
        //         i--;
        //     }
        // });

    </script>
{% endblock %}
